name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # ErmÃ¶glicht manuelles Triggern

jobs:
  deploy:
    name: Deploy to docker.fwv-raura.ch
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Check if server setup is needed
        id: check_setup
        run: |
          if ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'command -v docker &> /dev/null'; then
            echo "setup_needed=false" >> $GITHUB_OUTPUT
            echo "âœ“ Docker is already installed on server"
          else
            echo "setup_needed=true" >> $GITHUB_OUTPUT
            echo "âš  Docker not found - server setup will be performed"
          fi

      - name: Run server setup (if needed)
        if: steps.check_setup.outputs.setup_needed == 'true'
        run: |
          echo "ðŸš€ Running initial server setup..."

          # Upload setup script
          scp -P ${{ secrets.SERVER_PORT }} setup-server.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/setup-server.sh

          # Run setup script
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          chmod +x /tmp/setup-server.sh
          /tmp/setup-server.sh
          rm /tmp/setup-server.sh
          ENDSSH

          echo "âœ“ Server setup completed successfully"

      - name: Create deployment structure
        run: |
          mkdir -p n8n/data
          mkdir -p nextcloud/db
          mkdir -p nextcloud/html
          mkdir -p nextcloud/data
          mkdir -p nextcloud/config
          mkdir -p nextcloud/apps
          mkdir -p portainer/data
          mkdir -p authentik/postgresql
          mkdir -p authentik/redis
          mkdir -p authentik/media
          mkdir -p authentik/certs
          mkdir -p authentik/custom-templates
          mkdir -p crowdsec/config
          mkdir -p crowdsec/data

      - name: Deploy files to server
        run: |
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SERVER_PORT }}" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '.env' \
            --exclude 'traefik/acme.json' \
            --exclude 'n8n/data/*' \
            --exclude 'nextcloud/db/*' \
            --exclude 'nextcloud/html/*' \
            --exclude 'nextcloud/data/*' \
            --exclude 'nextcloud/config/*' \
            --exclude 'nextcloud/apps/*' \
            --exclude 'portainer/data/*' \
            --exclude 'authentik/postgresql/*' \
            --exclude 'authentik/redis/*' \
            --exclude 'authentik/media/*' \
            --exclude 'authentik/certs/*' \
            --exclude 'authentik/custom-templates/*' \
            --exclude 'crowdsec/config/*' \
            --exclude 'crowdsec/data/*' \
            --exclude 'README.md' \
            --exclude 'CROWDSEC.md' \
            --exclude 'AUTHENTIK-INTEGRATION.md' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Configure acme.json permissions
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          cd ${{ secrets.DEPLOY_PATH }}
          if [ ! -f traefik/acme.json ]; then
            touch traefik/acme.json
          fi
          chmod 600 traefik/acme.json
          ENDSSH

      - name: Create .env file from secrets
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          cat > ${{ secrets.DEPLOY_PATH }}/.env << 'EOF'
          # Domain Configuration
          DOMAIN_BASE=fwv-raura.ch
          TRAEFIK_DOMAIN=traefik.fwv-raura.ch
          PORTAINER_DOMAIN=portainer.fwv-raura.ch
          AUTHENTIK_DOMAIN=auth.fwv-raura.ch
          N8N_DOMAIN=n8n.fwv-raura.ch
          NEXTCLOUD_DOMAIN=cloud.fwv-raura.ch
          MAILCOW_DOMAIN=mail.fwv-raura.ch

          # Timezone
          TIMEZONE=Europe/Zurich

          # Traefik
          TRAEFIK_BASIC_AUTH=${{ secrets.TRAEFIK_BASIC_AUTH }}

          # Nextcloud Database
          NEXTCLOUD_DB_ROOT_PASSWORD=${{ secrets.NEXTCLOUD_DB_ROOT_PASSWORD }}
          NEXTCLOUD_DB_PASSWORD=${{ secrets.NEXTCLOUD_DB_PASSWORD }}

          # Nextcloud Admin
          NEXTCLOUD_ADMIN_USER=${{ secrets.NEXTCLOUD_ADMIN_USER }}
          NEXTCLOUD_ADMIN_PASSWORD=${{ secrets.NEXTCLOUD_ADMIN_PASSWORD }}

          # Authentik
          AUTHENTIK_SECRET_KEY=${{ secrets.AUTHENTIK_SECRET_KEY }}
          AUTHENTIK_ERROR_REPORTING=false
          AUTHENTIK_POSTGRESQL_PASSWORD=${{ secrets.AUTHENTIK_POSTGRESQL_PASSWORD }}
          AUTHENTIK_POSTGRESQL_USER=authentik
          AUTHENTIK_POSTGRESQL_NAME=authentik

          # CrowdSec
          CROWDSEC_BOUNCER_KEY_TRAEFIK=${{ secrets.CROWDSEC_BOUNCER_KEY_TRAEFIK }}

          # Watchtower
          WATCHTOWER_EMAIL_FROM=${{ secrets.WATCHTOWER_EMAIL_FROM }}
          WATCHTOWER_EMAIL_TO=${{ secrets.WATCHTOWER_EMAIL_TO }}
          WATCHTOWER_SMTP_SERVER=${{ secrets.WATCHTOWER_SMTP_SERVER }}
          WATCHTOWER_SMTP_PORT=${{ secrets.WATCHTOWER_SMTP_PORT }}
          WATCHTOWER_SMTP_USER=${{ secrets.WATCHTOWER_SMTP_USER }}
          WATCHTOWER_SMTP_PASSWORD=${{ secrets.WATCHTOWER_SMTP_PASSWORD }}
          EOF
          chmod 600 ${{ secrets.DEPLOY_PATH }}/.env
          ENDSSH

      - name: Create Docker networks
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          docker network create proxy 2>/dev/null || true
          docker network create nextcloud 2>/dev/null || true
          docker network create authentik 2>/dev/null || true
          ENDSSH

      - name: Pull and restart containers
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          cd ${{ secrets.DEPLOY_PATH }}
          docker-compose pull
          docker-compose up -d --remove-orphans
          docker-compose ps
          ENDSSH

      - name: Show deployment info
        run: |
          echo "âœ… Deployment erfolgreich!"
          echo ""
          echo "Services:"
          echo "  - Traefik: https://traefik.fwv-raura.ch"
          echo "  - Portainer: https://portainer.fwv-raura.ch"
          echo "  - Authentik: https://auth.fwv-raura.ch"
          echo "  - n8n: https://n8n.fwv-raura.ch"
          echo "  - Nextcloud: https://cloud.fwv-raura.ch"

      - name: Check container health
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          cd ${{ secrets.DEPLOY_PATH }}
          echo "Container Status:"
          docker-compose ps
          echo ""
          echo "Running Containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          ENDSSH
